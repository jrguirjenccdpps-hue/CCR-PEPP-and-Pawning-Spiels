<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CCR PEPP & Pawning Spiels</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root {
  --green-dark: #065f46;
  --green-main: #059669;
  --green-light: #d1fae5;
  --bg: #f0fdf4;
  --card: #ffffff;
  --text: #064e3b;
}

body {
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg);
  padding: 20px;
  color: var(--text);
  margin:0;
}

h2 { text-align: center; margin-bottom: 20px; }

/* Tabs */
.tabs { display: flex; gap: 10px; margin-bottom: 10px; }
.tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; background: #e5f7ed; font-weight: bold; transition: background 0.2s; }
.tab.active { background: var(--green-main); color: white; }
#tabContent { margin-top: 10px; min-height: 300px; overflow-y: auto; }

/* Search Input */
#search { width: 100%; padding: 12px; font-size: 15px; border-radius: 10px; border: 1px solid #a7f3d0; margin-bottom: 10px; }

/* Loader */
.loader { text-align: center; margin: 10px 0; display: none; }
.spinner { width: 36px; height: 36px; border: 4px solid #d1fae5; border-top: 4px solid var(--green-main); border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
.loader-text { margin-top: 6px; font-size: 13px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Search Results Cards */
.card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; }
.card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
.spiel-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.spiel { font-size: 1rem; font-weight: 700; color: var(--green-dark); }
.star { font-size: 20px; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
.star.active { color: #facc15; }
.response-container { display: flex; flex-direction: column; gap: 8px; }
.response { background: #f0fdf4; padding: 10px 12px; border-radius: 10px; font-size: 0.95rem; position: relative; }
.label { font-weight: bold; margin-bottom: 4px; color: var(--green-dark); }
.copy-content { white-space: pre-wrap; line-height: 1.5; }
.actions { display: flex; justify-content: flex-end; margin-top: 6px; }
.copy-btn { padding: 5px 8px; font-size: 12px; font-weight: bold; border-radius: 6px; border: none; background: var(--green-main); color: white; cursor: pointer; transition: background 0.2s; }
.copy-btn:hover { background: var(--green-dark); }
.copied { position: absolute; top: 10px; right: 10px; font-size: 11px; color: #059669; display: none; }

/* Memo Cards */
.memo-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.08); display: flex; gap: 12px; align-items: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
.memo-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
.memo-icon { font-size: 28px; }
.memo-title { font-weight: bold; }
.memo-sub { font-size: 0.8rem; color: #047857; }

/* Logout & Login */
.logout { position: fixed; top: 10px; right: 10px; background: #dc2626; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; display: none; }

#loginOverlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.4);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(3px);
  opacity: 0;
  animation: fadeOverlay 0.5s forwards;
}
@keyframes fadeOverlay { from { opacity: 0; } to { opacity: 1; } }

.login-box {
  background: #fff; padding: 25px; border-radius: 12px; width: 300px;
  transform: translateY(-30px);
  opacity: 0;
  animation: slideFade 0.5s forwards;
}
@keyframes slideFade { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.login-box input { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #a7f3d0; }
.login-box button { width:100%; padding:10px; margin-top:10px; background:#059669; color:#fff; border:none; border-radius:6px; cursor:pointer; transition:.2s; }
.login-box button:hover { background:#065f46; }
#msg { color:red; margin-top:6px; text-align:center; }

/* PDF Modal */
#pdfModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  z-index: 1000;
  backdrop-filter: blur(2px);
  transition: opacity 0.3s ease;
}
#pdfModal.show { opacity: 1; }

#pdfModal iframe { width:90%; max-width:800px; height:80vh; border:none; border-radius:10px; }
#pdfToolbarModal { display:flex; justify-content:space-between; width:90%; max-width:800px; margin-bottom:5px; }
#pdfToolbarModal button { padding:5px 8px; margin-left:5px; cursor:pointer; }
</style>
</head>
<body>

<button class="logout" onclick="logout()">Logout</button>
<h2>CCR PEPP & Pawning Spiels</h2>

<div class="tabs">
  <div class="tab active" data-tab="search">Search Spiels</div>
  <div class="tab" data-tab="money">Money Changer</div>
  <div class="tab" data-tab="gold">Palawan Gold</div>
  <div class="tab" data-tab="memo">Memo & Advisory</div>
</div>

<div id="tabContent">
  <!-- Search Spiels -->
  <div id="searchTab">
    <input type="text" id="search" placeholder="Search Spiel Name...">
    <div class="loader" id="loader">
      <div class="spinner"></div>
      <div class="loader-text">Searching spiels...</div>
    </div>
    <div id="results"></div>
  </div>

  <!-- Money Changer -->
  <iframe id="moneyTab" src="https://jrguirjenccdpps-hue.github.io/Money-Changer/" style="display:none;"></iframe>

  <!-- Palawan Gold -->
  <iframe id="goldTab" src="https://jrguirjenccdpps-hue.github.io/Palawan-Gold-Price/" style="display:none;"></iframe>

  <!-- MEMO TAB -->
  <div id="memoTab" style="display:none">
    <div class="memo-card" onclick="showPDF(
      'https://drive.google.com/file/d/1k-IFfleDsUp4SGbqmzLWN6HcyRS37sbr/view',
      'Annex C â€“ Guidelines for Authorized Representatives'
    )">
      <div class="memo-icon">ðŸ“„</div>
      <div>
        <div class="memo-title">Annex C â€“ Guidelines for Authorized Representatives</div>
        <div class="memo-sub">Effective Sept 1, 2023</div>
      </div>
    </div>

    <div class="memo-card" onclick="showPDF(
      'https://drive.google.com/file/d/1xCpK6LulqyFfW1wC6U5rcuy6Alz0RaJ9/view',
      'Annex D â€“ ID Requirements'
    )">
      <div class="memo-icon">ðŸ“„</div>
      <div>
        <div class="memo-title">Annex D â€“ ID Requirements</div>
        <div class="memo-sub">Effective June 1, 2023</div>
      </div>
    </div>

    <div class="memo-card" onclick="showPDF(
      'https://drive.google.com/file/d/1f_pHNFTgN3n4Af50V-IOI3PXUrb6_M5l/view',
      'GM 006, S2023 â€“ International Remittance Partners'
    )">
      <div class="memo-icon">ðŸ“„</div>
      <div>
        <div class="memo-title">GM 006, S2023 â€“ International Remittance Partners</div>
        <div class="memo-sub">Attachment</div>
      </div>
    </div>

    <div class="memo-card" onclick="showPDF(
      'https://drive.google.com/file/d/1BDeVgr4arXJmdgQoTIcRSZA3cSuBC_cX/view',
      'GM 020, S2023 â€“ Western Union Registered Branches'
    )">
      <div class="memo-icon">ðŸ“„</div>
      <div>
        <div class="memo-title">GM 020, S2023 â€“ Western Union Registered Branches</div>
        <div class="memo-sub">Attachment</div>
      </div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-box">
    <h3>Login</h3>
    <input id="user" placeholder="Username">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="loginUser()">Login</button>
    <div id="msg"></div>
  </div>
</div>

<!-- PDF Modal -->
<div id="pdfModal">
  <div id="pdfToolbarModal">
    <div id="pdfTitleModal" style="color:white; font-weight:bold;"></div>
    <div>
      <button onclick="openNewTab()">Open New Tab</button>
      <button onclick="closePDF()">Close</button>
    </div>
  </div>
  <iframe id="pdfFrame"></iframe>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzP86WpTYekm5GjJTcoXHpDk1c6dWB3ygFOit4HVrr1lkQuZeeaMEuNRdSXJAdJbaQLZg/exec";

const tabs=document.querySelectorAll(".tab");
const searchTab=document.getElementById("searchTab");
const moneyTab=document.getElementById("moneyTab");
const goldTab=document.getElementById("goldTab");
const memoTab=document.getElementById("memoTab");
const loader=document.getElementById("loader");
const results=document.getElementById("results");
const loginOverlay=document.getElementById("loginOverlay");
const msg=document.getElementById("msg");
const user=document.getElementById("user");
const pass=document.getElementById("pass");
const logoutBtn=document.querySelector(".logout");
const pdfModal=document.getElementById("pdfModal");
const pdfFrame=document.getElementById("pdfFrame");
const pdfTitleModal=document.getElementById("pdfTitleModal");
let idleTimer;

// ===== LOGIN =====
function loginUser(){
  msg.textContent="";
  fetch(WEB_APP_URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({ username:user.value, password:pass.value })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d.success){ msg.textContent=d.message; return; }
    loginOverlay.style.display="none";
    logoutBtn.style.display="block";
    resetIdle();
  }).catch(()=>{msg.textContent="Server error";});
}

// ===== SEARCH SPIELS =====
let favorites = JSON.parse(localStorage.getItem("favorites")) || [];
let typingTimer;
const TYPING_DELAY = 300;
document.getElementById("search").addEventListener("input", () => {
  clearTimeout(typingTimer);
  typingTimer = setTimeout(searchSpiel, TYPING_DELAY);
});

function searchSpiel() {
  const q = document.getElementById("search").value.trim();
  results.innerHTML = "";
  if (!q) return;
  loader.style.display = "block";

  fetch(`${WEB_APP_URL}?action=search&q=${encodeURIComponent(q)}`)
    .then(res => res.json())
    .then(data => {
      loader.style.display = "none";
      renderResults(data);
    })
    .catch(()=> loader.style.display = "none");
}

function renderResults(data) {
  const container = results;
  container.innerHTML = "";
  if (!data || data.length === 0) { container.innerHTML = "<p>No results found.</p>"; return; }

  data.sort((a,b) => favorites.includes(b.spiel) - favorites.includes(a.spiel));

  data.forEach(item => {
    const isFav = favorites.includes(item.spiel);
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="spiel-row">
        <div class="spiel">${item.spiel}</div>
        <div class="star ${isFav ? "active" : ""}" onclick="toggleFavorite('${item.spiel}')">â˜…</div>
      </div>
      <div class="response-container">
        <div class="response">
          <div class="label">English Response</div>
          <div class="copy-content">${formatText(item.english)}</div>
          <div class="actions"><button class="copy-btn" onclick="copyOnly(this)">Copy English</button></div>
          <div class="copied">Copied!</div>
        </div>
        <div class="response">
          <div class="label">Tagalog Response</div>
          <div class="copy-content">${formatText(item.tagalog)}</div>
          <div class="actions"><button class="copy-btn" onclick="copyOnly(this)">Copy Tagalog</button></div>
          <div class="copied">Copied!</div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}

function copyOnly(btn){
  const content = btn.closest(".response").querySelector(".copy-content");
  const range = document.createRange();
  range.selectNodeContents(content);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
  document.execCommand("copy");
  sel.removeAllRanges();
  const copied = btn.closest(".response").querySelector(".copied");
  copied.style.display="block";
  setTimeout(()=> copied.style.display="none", 1000);
}

function toggleFavorite(spiel){
  favorites = favorites.includes(spiel) ? favorites.filter(f=>f!==spiel) : [...favorites, spiel];
  localStorage.setItem("favorites", JSON.stringify(favorites));
  searchSpiel();
}

function formatText(text){
  if(!text) return "";
  return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
}

// ===== TABS =====
tabs.forEach(t=>{
  t.onclick=()=>{
    tabs.forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    searchTab.style.display = t.dataset.tab==="search"?"block":"none";
    moneyTab.style.display = t.dataset.tab==="money"?"block":"none";
    goldTab.style.display = t.dataset.tab==="gold"?"block":"none";
    memoTab.style.display = t.dataset.tab==="memo"?"block":"none";
  };
});

// ===== LOGOUT & IDLE =====
function logout(){ location.reload(); }
function resetIdle(){ clearTimeout(idleTimer); idleTimer=setTimeout(logout,5*60*1000); }
["mousemove","keydown","click","scroll"].forEach(e=>document.addEventListener(e,resetIdle));

// ===== PDF MODAL =====
function showPDF(url, title="") {
  pdfFrame.src = url.replace("/view","/preview");
  pdfTitleModal.textContent = title;
  pdfModal.style.display = "flex";
  setTimeout(()=> pdfModal.classList.add("show"),50);
}
function closePDF() {
  pdfModal.classList.remove("show");
  setTimeout(()=>{
    pdfModal.style.display="none";
    pdfFrame.src="";
  },400);
}
function openNewTab() {
  if(pdfFrame.src) window.open(pdfFrame.src,"_blank");
}
</script>
</body>
</html>
